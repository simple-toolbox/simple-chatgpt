#!/usr/bin/env bash
set -euo pipefail

SHORTCUT_NAME="simple-chatgpt"
CHATGPT_APP_NAME="ChatGPT"

usage() {
  status="${1:-0}"
  cat >&2 <<EOF
Usage:
  $(basename "$0") "your question"
  $(basename "$0") -f INPUT_FILE
  $(basename "$0") -o OUTPUT_FILE "your question"
  $(basename "$0") -f INPUT_FILE -o OUTPUT_FILE

Options:
  -f FILE   Read prompt from FILE instead of command-line arguments
  -o FILE   Write response to FILE instead of stdout
  -h        Show this help
EOF
  exit "$status"
}

is_chatgpt_running() {
  osascript -e 'application "ChatGPT" is running' 2>/dev/null | grep -qi true
}

open_chatgpt() {
  if ! open -a "$CHATGPT_APP_NAME" >/dev/null 2>&1; then
    echo "Could not open $CHATGPT_APP_NAME. Is it installed?" >&2
    return 1
  fi

  for _ in {1..20}; do
    sleep 0.2
    if is_chatgpt_running; then
      return 0
    fi
  done

  echo "Timed out waiting for $CHATGPT_APP_NAME to start." >&2
  return 1
}

ensure_chatgpt_running() {
  if is_chatgpt_running; then
    return 0
  fi

  open_chatgpt
}

run_shortcut() {
  set +e
  ANSWER=$(printf '%s' "$prompt" | shortcuts run "$SHORTCUT_NAME" 2>&1)
  local status=$?
  set -e
  return "$status"
}

input_file=""
output_file=""

# Parse flags
while getopts ":f:o:h" opt; do
  case "$opt" in
    f) input_file="$OPTARG" ;;
    o) output_file="$OPTARG" ;;
    h) usage 0 ;;
    \?) echo "Unknown option: -$OPTARG" >&2; usage 1 ;;
    :)  echo "Option -$OPTARG requires an argument." >&2; usage 1 ;;
  esac
done

shift $((OPTIND - 1))

# Determine prompt source: file or args
if [ -n "$input_file" ]; then
  if [ ! -f "$input_file" ]; then
    echo "Input file not found: $input_file" >&2
    exit 1
  fi
  prompt=$(cat "$input_file")
else
  if [ "$#" -eq 0 ]; then
    echo "Error: no prompt provided." >&2
    usage 1
  fi
  prompt="$*"
fi

ensure_chatgpt_running

if ! run_shortcut; then
  echo "$ANSWER" >&2
  exit 1
fi

# Output: stdout by default, or file if -o is provided
if [ -n "$output_file" ]; then
  printf '%s\n' "$ANSWER" > "$output_file"
else
  printf '%s\n' "$ANSWER"
fi
